<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FotoGallery | Upload ke GitHub</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" defer></script>
  <style>
    :root{
      --bg1: #0f172a;
      --bg2: #0b1220;
      --glass: rgba(255,255,255,0.04);
      --accent: linear-gradient(90deg,#8b5cf6,#f472b6);
      --primary: #8b5cf6;
      --muted: #9aa3c1;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{
      margin:0;min-height:100vh;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef8;
      display:flex;align-items:center;justify-content:center;padding:32px;
    }
    .card{
      width:100%;max-width:1000px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:18px;padding:28px;border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(8px);
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
    }
    header{display:flex;gap:18px;align-items:center;margin-bottom:18px;}
    .logo{
      width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#ec4899);
      display:flex;align-items:center;justify-content:center;font-size:26px;color:white;
      box-shadow:0 6px 18px rgba(124,58,237,0.18);
    }
    h1{font-size:20px;margin:0}
    p.subtitle{margin:4px 0 0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 400px;gap:22px;margin-top:20px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--glass);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .upload-area{border:2px dashed rgba(255,255,255,0.04);border-radius:12px;padding:28px;text-align:center;cursor:pointer}
    .upload-area:hover{transform:translateY(-4px);transition:all .18s}
    .upload-btn{background:var(--primary);border:none;color:white;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:600}
    .image-preview{width:100%;height:260px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
    .info-row{display:flex;justify-content:space-between;padding:6px 0;color:var(--muted);font-size:13px}
    .result{display:none;margin-top:12px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.03)}
    .status{display:none;padding:10px;border-radius:8px;margin-top:10px}
    .status.success{background:rgba(34,197,94,0.08);color:#86efac;border:1px solid rgba(34,197,94,0.12)}
    .status.error{background:rgba(239,68,68,0.06);color:#fca5a5;border:1px solid rgba(239,68,68,0.1)}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;margin-top:10px}
    .copy-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--primary);padding:8px 10px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div class="logo"><i class="fas fa-cloud-upload-alt"></i></div>
      <div>
        <h1>FotoGallery</h1>
        <p class="subtitle">Upload foto ke GitHub via backend secure (Vercel). Token tidak disimpan di browser.</p>
      </div>
    </header>

    <div class="grid">
      <div class="panel">
        <div id="uploadArea" class="upload-area">
          <input id="fileInput" type="file" accept="image/*" style="display:none"/>
          <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
            <div style="font-size:34px;color:rgba(255,255,255,0.9)"><i class="fas fa-file-image"></i></div>
            <div style="font-weight:600">Seret atau pilih file</div>
            <div class="small">JPG / PNG / GIF / WEBP (max 10MB)</div>
            <button id="selectBtn" class="upload-btn" style="margin-top:10px">Pilih Foto</button>
          </div>
        </div>

        <div id="status" class="status" style="margin-top:12px"></div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="uploadBtn" class="upload-btn">Upload ke GitHub</button>
          <div class="small" id="loading" style="display:none">Mengupload…</div>
        </div>
      </div>

      <div class="panel">
        <div id="previewContainer">
          <img id="imagePreview" class="image-preview" src="https://raw.githubusercontent.com/Hanckdad/Database-Foto/main/images/1764415844797-1000303536.jpg" alt="preview"/>
          <div style="margin-top:10px">
            <div class="info-row"><div class="small">Nama File</div><div id="fileName" class="small">1000303536.jpg</div></div>
            <div class="info-row"><div class="small">Ukuran</div><div id="fileSize" class="small">2.4 MB</div></div>
            <div class="info-row"><div class="small">Dimensi</div><div id="fileDimensions" class="small">1920 × 1080</div></div>
            <div class="info-row"><div class="small">Format</div><div id="fileFormat" class="small">JPEG</div></div>
          </div>

          <div id="result" class="result">
            <div style="font-weight:700;color:var(--primary)">Upload Berhasil</div>
            <div style="margin-top:8px;font-family:monospace;font-size:13px" id="imageLink"></div>
            <div class="actions">
              <button id="copyBtn" class="copy-btn"><i class="fas fa-copy"></i> Salin Link</button>
              <button id="viewBtn" class="copy-btn"><i class="fas fa-external-link-alt"></i> Lihat</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>Made with <i class="fas fa-heart" style="color:#f472b6"></i> — Deploy to Vercel and set <code>GITHUB_TOKEN</code> in Environment</footer>
  </div>

<script>
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const selectBtn = document.getElementById('selectBtn');
  const previewContainer = document.getElementById('previewContainer');
  const imagePreview = document.getElementById('imagePreview');
  const uploadBtn = document.getElementById('uploadBtn');
  const loading = document.getElementById('loading');
  const status = document.getElementById('status');
  const result = document.getElementById('result');
  const imageLink = document.getElementById('imageLink');
  const copyBtn = document.getElementById('copyBtn');
  const viewBtn = document.getElementById('viewBtn');

  const fileNameEl = document.getElementById('fileName');
  const fileSizeEl = document.getElementById('fileSize');
  const fileDimensions = document.getElementById('fileDimensions');
  const fileFormat = document.getElementById('fileFormat');

  selectBtn.addEventListener('click', () => fileInput.click());
  uploadArea.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', handleFileSelect);
  uploadBtn.addEventListener('click', uploadToGitHub);
  copyBtn.addEventListener('click', copyLink);
  viewBtn.addEventListener('click', () => window.open(imageLink.textContent, '_blank'));

  uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.style.transform='translateY(-6px)'; });
  uploadArea.addEventListener('dragleave', e => { uploadArea.style.transform='none'; });
  uploadArea.addEventListener('drop', e => {
    e.preventDefault();
    uploadArea.style.transform='none';
    if (e.dataTransfer.files.length) {
      fileInput.files = e.dataTransfer.files;
      handleFileSelect();
    }
  });

  function showStatus(msg, type) {
    status.textContent = msg;
    status.className = 'status ' + (type || '');
    status.style.display = 'block';
  }

  function formatFileSize(bytes) {
    if (!bytes) return '0 Bytes';
    const k = 1024; const sizes = ['Bytes','KB','MB','GB'];
    const i = Math.floor(Math.log(bytes)/Math.log(k));
    return parseFloat((bytes/Math.pow(k,i)).toFixed(2)) + ' ' + sizes[i];
  }

  function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function handleFileSelect() {
    const file = fileInput.files[0];
    if (!file) { showStatus('Silakan pilih file.', 'error'); return; }
    if (!file.type.startsWith('image/')) { showStatus('Bukan file gambar.', 'error'); return; }
    if (file.size > 10 * 1024 * 1024) { showStatus('Ukuran file > 10MB', 'error'); return; }

    const reader = new FileReader();
    reader.onload = e => {
      imagePreview.src = e.target.result;
      fileNameEl.textContent = file.name;
      fileSizeEl.textContent = formatFileSize(file.size);
      fileFormat.textContent = file.type.split('/')[1].toUpperCase();
      const img = new Image();
      img.onload = () => fileDimensions.textContent = img.width + ' × ' + img.height;
      img.src = e.target.result;
      status.style.display = 'none';
      result.style.display = 'none';
    };
    reader.readAsDataURL(file);
  }

  async function uploadToGitHub() {
    const file = fileInput.files[0];
    if (!file) { showStatus('Silakan pilih file terlebih dahulu.', 'error'); return; }

    loading.style.display = 'inline';
    uploadBtn.disabled = true;
    status.style.display = 'none';
    try {
      const base64 = await readFileAsBase64(file);
      const fileName = Date.now() + '-' + file.name;

      // STEP 1: Upload ke backend (Vercel) yang akan memanggil GitHub API
      const uploadResp = await fetch('/api/upload', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ fileName, content: base64 })
      });

      const uploadData = await uploadResp.json();
      if (!uploadResp.ok) throw new Error(uploadData.message || uploadData.error || 'Upload gagal');

      const imageUrl = uploadData.download_url;

      // STEP 2: Buat issue
      const issueResp = await fetch('/api/issue', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          title: 'Foto Baru: ' + file.name,
          body: `Foto baru telah diupload:\n\n![${file.name}](${imageUrl})`
        })
      });

      if (!issueResp.ok) {
        const err = await issueResp.json();
        console.warn('Issue error', err);
      }

      imageLink.textContent = imageUrl;
      result.style.display = 'block';
      showStatus('Upload berhasil! Link siap digunakan.', 'success');

    } catch (err) {
      console.error(err);
      showStatus(err.message || 'Terjadi kesalahan', 'error');
    } finally {
      loading.style.display = 'none';
      uploadBtn.disabled = false;
    }
  }

  function copyLink() {
    const txt = imageLink.textContent;
    if (!txt) return showStatus('Belum ada link.', 'error');
    navigator.clipboard.writeText(txt).then(()=> showStatus('Link disalin!', 'success'))
    .catch(e=> showStatus('Gagal menyalin: '+e, 'error'));
  }

  document.addEventListener('DOMContentLoaded', ()=> { /* nothing for now */ });
</script>
</body>
</html>
